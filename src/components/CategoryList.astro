---
// 从 starlightBlog 获取文章数据
const starlightBlog = Astro.locals?.starlightBlog;
let posts = [];

if (starlightBlog && starlightBlog.posts) {
  posts = starlightBlog.posts;
  
  // 修复链接：确保每篇文章都有正确的href
  posts = posts.map(post => {
    if (!post.href || post.href.includes('undefined')) {
      const blogPath = post.entry.id.replace(/^blog\//, '').replace(/\.mdx?$/, '');
      return {
        ...post,
        href: `/blog/${post.entry.slug || blogPath}`
      };
    }
    return post;
  });
}

const categories = {};

// 收集所有分类
for (const post of posts) {
  const category = post.entry?.data?.category || '未分类';
  if (!categories[category]) {
    categories[category] = [];
  }
  categories[category].push(post);
}

// 转换为数组并排序
const sortedCategories = Object.entries(categories).sort((a, b) => a[0].localeCompare(b[0]));
---

<div class="categories-container">
  {sortedCategories.map(([category, posts]) => (
    <div class="category-section">
      <h2>{category}</h2>
      <div class="posts-list">
        {posts.map((post) => (
          <a href={post.href} class="post-link">
            {post.title}
          </a>
        ))}
      </div>
    </div>
  ))}
</div>

<style>
  .categories-container {
    max-width: var(--sl-content-width);
    margin: 0 auto;
    padding: 2rem 1rem;
  }

  .category-section {
    margin-bottom: 3rem;
  }

  .category-section h2 {
    font-size: 1.5rem;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--sl-color-gray-5);
  }

  .posts-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .post-link {
    color: var(--sl-color-text);
    text-decoration: none;
    padding: 0.5rem;
    border-radius: 0.25rem;
    transition: all 0.2s ease;
  }

  .post-link:hover {
    background-color: var(--sl-color-accent-low);
    color: var(--sl-color-accent);
  }

  @media (max-width: 768px) {
    .posts-list {
      gap: 0.25rem;
    }
  }
</style> 
