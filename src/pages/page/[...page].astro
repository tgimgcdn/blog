---
// 直接导入博客插件的内部函数
import { getBlogData } from 'starlight-blog/middleware';
import { getBlogEntries } from 'starlight-blog/libs/content';
import HomePage from '../../components/HomePage.astro';

export async function getStaticPaths() {
  // 尝试获取所有博客文章
  let totalArticles = 0;
  let totalPages = 0;
  
  try {
    // 直接从博客插件获取文章
    const entries = await getBlogEntries('root');
    totalArticles = entries.length;
    const postsPerPage = 9; // 每页9篇文章
    totalPages = Math.ceil(totalArticles / postsPerPage);
    
    console.log(`[...page].astro: 总文章数=${totalArticles}, 总页数=${totalPages}`);
  } catch (error) {
    console.error("获取博客文章失败:", error);
    // 如果无法获取，默认生成2页
    totalPages = 2;
  }
  
  // 为所有页面生成路径
  const paths = [];
  
  // 首页重定向
  paths.push({
    params: { page: undefined },
    props: { pageNum: 1 }
  });
  
  // 后续页面: /page/2/, /page/3/ 等
  for (let i = 2; i <= totalPages; i++) {
    paths.push({
      params: { page: String(i) },
      props: { pageNum: i }
    });
  }
  
  return paths;
}

// 从路由参数获取页码
const { pageNum } = Astro.props;

// 创建一个类似于Starlight路由数据的对象
const starlightRoute = {
  locale: 'root', // 假设使用默认语言
  slug: '/',
  id: 'index',
  isFallback: false,
  entryMeta: {},
  entries: {}
};

// 尝试直接获取博客数据
try {
  // 直接调用博客插件的函数获取数据
  const blogData = await getBlogData(starlightRoute);
  
  // 如果成功获取，设置它到Astro.locals以便HomePage组件可以使用
  if (!Astro.locals) {
    Astro.locals = {};
  }
  Astro.locals.starlightBlog = blogData;
  
  console.log(`[...page].astro 页面 ${pageNum}: 成功获取博客数据，文章数:`, blogData.posts?.length || 0);
} catch (error) {
  console.error(`[...page].astro 页面 ${pageNum}: 获取博客数据失败:`, error);
  
  // 尝试第二种方法：直接获取文章
  try {
    const entries = await getBlogEntries('root');
    console.log(`[...page].astro 页面 ${pageNum}: 成功通过备用方法获取博客文章，文章数:`, entries.length);
    
    // 创建一个类似的数据结构
    if (!Astro.locals) {
      Astro.locals = {};
    }
    Astro.locals.starlightBlog = {
      posts: entries.map(entry => ({
        entry,
        href: `/blog/${entry.slug || entry.id.replace(/^blog\//, '').replace(/\.mdx?$/, '')}`,
        title: entry.data.title
      }))
    };
  } catch (secondError) {
    console.error(`[...page].astro 页面 ${pageNum}: 备用方法也失败:`, secondError);
  }
}
---

<HomePage pageNum={pageNum} /> 
